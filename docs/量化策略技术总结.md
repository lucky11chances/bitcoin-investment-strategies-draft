# 量化策略技术总结

## 策略概述

本量化策略是一个基于多因子模型的比特币交易系统，通过结合技术分析指标和市场结构特征，构建动态持仓信号，目标是最大化训练集的Sharpe比率。

---

## 一、策略形成过程

### 1. 因子设计阶段
策略首先识别了可能影响比特币价格走势的10个关键因子，涵盖动量、趋势、波动率和市场周期四个维度。

### 2. 因子标准化
使用**滚动Z-score标准化**（90天窗口），确保不同量纲的因子具有可比性：
```
Z-score = (当前值 - 滚动均值) / 滚动标准差
```

### 3. 信号合成
通过加权求和将标准化后的因子合成为综合信号：
```
Score_t = w₁×F₁_t + w₂×F₂_t + ... + w₁₀×F₁₀_t
```

### 4. 持仓映射
使用**Sigmoid函数**将信号转换为0-100%的连续持仓比例：
```
Position_t = 1 / (1 + e^(-Score_t))
```
- Score > 2 → 持仓接近100%（强看多）
- Score ≈ 0 → 持仓约50%（中性）
- Score < -2 → 持仓接近0%（强看空）

### 5. 权重优化
采用**随机游走搜索算法**（Random Walk Search），通过300步迭代寻找最优权重组合，并加入L2正则化防止过拟合：
```
目标函数 = Sharpe比率 - 0.012 × ||weights||²
步长: 0.05（保守搜索）
交易成本: 15 bps（真实约束）
```

---

## 二、十大技术因子

### 📈 动量因子 (Momentum)
| 因子 | 计算方式 | 经济含义 |
|------|---------|---------|
| **MOM_20** | 20日收益率 | 短期价格趋势强度 |
| **MOM_60** | 60日收益率 | 中期价格趋势强度 |

**逻辑**: 价格动量持续性，"强者恒强"效应

---

### 📊 均线价差因子 (Moving Average Spread)
| 因子 | 计算方式 | 经济含义 |
|------|---------|---------|
| **MA_50_SPREAD** | (价格 - MA50) / MA50 | 价格相对中期均线的偏离度 |
| **MA_200_SPREAD** | (价格 - MA200) / MA200 | 价格相对长期均线的偏离度 |

**逻辑**: 
- 价格 > 均线 → 多头市场
- 价格 < 均线 → 空头市场或超买/超卖信号

---

### 📉 波动率因子 (Volatility)
| 因子 | 计算方式 | 经济含义 |
|------|---------|---------|
| **VOL_20** | 20日收益率标准差 | 短期市场波动程度 |
| **ATR_PCT_14** | 14日ATR / 价格 | 真实波动幅度（考虑跳空） |
| **VOL_RATIO_20** | 当前交易量 / 20日均量 | 成交量相对活跃度 |

**逻辑**: 
- 高波动可能预示趋势反转或突破
- 成交量放大通常伴随重要行情

---

### 🎯 价格位置因子 (Price Position)
| 因子 | 计算方式 | 经济含义 |
|------|---------|---------|
| **PRICE_POS_60** | (价格 - 60日最低) / (60日最高 - 60日最低) | 价格在60日区间的相对位置 |
| **CLOSE_POS** | (收盘 - 最低) / (最高 - 最低) | 当日价格在日内区间的位置 |

**逻辑**: 
- 接近区间顶部 → 超买，可能回调
- 接近区间底部 → 超卖，可能反弹

---

### 🔄 市场周期因子 (Market Cycle)
| 因子 | 计算方式 | 经济含义 |
|------|---------|---------|
| **POST_HALVING** | 距离最近减半天数 / 1460 | 比特币减半周期位置 |

**逻辑**: 
- 比特币每4年减半，历史上减半后常出现牛市
- 周期性规律可能影响价格走势

---

## 三、权重分配机制

### 随机游走优化算法 (Random Walk Search)

#### 算法流程
```
1. 初始化：随机生成10个权重 w = [w₁, w₂, ..., w₁₀]
2. 循环2000步：
   a. 生成扰动：Δw ~ N(0, 0.1²)  # 正态分布随机噪声
   b. 候选权重：w_new = w_old + Δw
   c. 计算Sharpe：在训练集上回测 w_new 的表现
   d. 贪婪更新：if Sharpe(w_new) > Sharpe(w_old):
                  w_old = w_new  # 接受更优解
   e. 记录最佳：持续跟踪历史最佳Sharpe和对应权重
3. 输出：返回2000步中Sharpe最高的权重组合
```

#### 关键参数
- **步数**: 2000步（平衡计算成本与优化效果）
- **步长**: 标准差0.1（控制探索范围）
- **目标函数**: Sharpe Ratio（风险调整后收益）
- **无风险利率**: 3%年化

#### 优化结果
最终权重: `[1.70, -6.83, -1.58, 4.51, -0.69, 3.13, 2.07, 7.83, 3.29, -2.19]`

训练集最佳Sharpe: **2.21**

---

## 四、权重解读

### 正权重因子（看多信号）
| 因子 | 权重 | 解释 |
|------|------|------|
| **PRICE_POS_60** | +7.83 | 价格处于高位时增加持仓 |
| **MA_50_SPREAD** | +4.51 | 价格高于50日均线时看多 |
| **CLOSE_POS** | +3.29 | 日内收盘强势时加仓 |
| **ATR_PCT_14** | +3.13 | 波动率上升时适度加仓 |
| **VOL_RATIO_20** | +2.07 | 成交量放大时跟随趋势 |
| **MOM_20** | +1.70 | 短期动量正向时持有 |

### 负权重因子（看空信号）
| 因子 | 权重 | 解释 |
|------|------|------|
| **MOM_60** | -6.83 | 中期涨幅过大时减仓（均值回归） |
| **POST_HALVING** | -2.19 | 减半周期后期降低仓位 |
| **MA_200_SPREAD** | -1.58 | 远离长期均线时谨慎 |
| **VOL_20** | -0.69 | 短期波动过高时降低风险敞口 |

### 策略特征
1. **趋势跟随 + 均值回归混合**: 短期动量做多，中期涨幅过高反向操作
2. **高权重集中**: PRICE_POS_60和MOM_60主导决策
3. **风险管理**: 波动率因子调节持仓强度

---

## 五、策略表现与过拟合分析

### 📊 训练集表现 (2010-2020)
- **最终价值**: $2.66B
- **Sharpe比率**: 1.98
- **表现**: 略优于DCA ($2.31B)，但远低于HODL ($5.3B)

### 📉 测试集表现 (2023-2024)
- **最终价值**: $18,156
- **Sharpe比率**: 1.08
- **表现**: 输给HODL和DCA，证明策略泛化能力不足

### ⚠️ 过拟合分析

**性能下降原因**:
1. **权重针对历史环境优化**: 2010-2020的市场特征与2023-2024不同
2. **优化参数选择**: 虽然已加入正则化，但仍存在一定过拟合
3. **因子时效性**: 部分技术因子在新市场环境下失效

**防过拟合措施（已实施）**:
1. ✅ **L2正则化**: 惩罚系数0.012，限制权重过大
2. ✅ **交易成本**: 15 bps真实成本约束
3. ✅ **保守优化**: 300步（vs原2000步）
4. ✅ **小步搜索**: 步长0.05（vs原0.5）
5. ✅ **动态仓位**: sigmoid输出连续仓位，避免极端切换

**改进方向**:
1. **时间序列交叉验证**: 滚动窗口验证策略稳定性
2. **因子重要性分析**: 剔除不稳定因子
3. **集成学习**: 多模型组合降低单一模型风险
4. **在线学习**: 定期更新权重适应市场变化
5. **止损机制**: 添加最大回撤限制

---

## 六、技术实现亮点

### 1. 动态仓位管理
```python
# Sigmoid函数支持0-100%连续仓位
Position_t = 1.0 / (1 + exp(-Score_t))
```
- 不仅仅是满仓/空仓
- 支持30%、60%、85%等任意仓位
- 根据信号强度灵活调整

### 2. L2正则化优化
```python
# 惩罚极端权重
Penalized_Sharpe = Raw_Sharpe - 0.012 × ||weights||²
```
- 防止权重过大
- 提高模型泛化能力
- 降低过拟合风险

### 3. 真实成本模拟
- 交易成本：15 bps
- 每次仓位变动都计算成本
- 更接近实际交易环境

---

## 七、总结

本量化策略展示了**多因子模型**在加密货币领域的应用框架，通过技术因子捕捉市场动态，并用随机优化算法自动搜索最优权重。

**核心价值**：
- ✅ 完整的量化策略开发流程
- ✅ 展示过拟合问题及防范措施
- ✅ 真实的回测框架（包含成本）
- ✅ 动态仓位管理机制

**关键教训**：
> **训练集优异表现≠实际盈利能力。样本外验证是策略可靠性的唯一标准。**

对于实际交易，建议：
1. 严格的样本外测试
2. 多时期交叉验证
3. 保守的参数选择
4. 完善的风险管理

---

**策略文件**: `src/strategies/quant_rf.py`  
**技术栈**: Python + Pandas + NumPy  
**数据周期**: 日频数据  
**作者**: Haoyu  
**更新时间**: 2025年12月14日
